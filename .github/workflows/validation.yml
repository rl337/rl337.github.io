name: Validation Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        working-directory: docs/
        
    - name: Install Python dependencies
      run: |
        cd scripts
        python -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8 black isort mypy
        
    - name: Install Jekyll dependencies
      run: |
        cd docs
        bundle install
        
    - name: Run comprehensive validation
      run: |
        chmod +x run_checks.sh
        ./run_checks.sh
        
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: validation-results
        path: |
          scripts/coverage.xml
          scripts/htmlcov/
        retention-days: 7
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // This would be enhanced to parse actual test results
          const comment = `## üîç Validation Results
          
          **Status:** ${process.env.VALIDATION_STATUS || 'Completed'}
          
          All validation checks have been run. Check the Actions tab for detailed results.
          
          ### Checks Performed:
          - ‚úÖ Python syntax and linting
          - ‚úÖ Jekyll build validation  
          - ‚úÖ Shell script validation
          - ‚úÖ YAML syntax validation
          - ‚úÖ File structure validation
          - ‚úÖ Security checks
          
          View full details in the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  jekyll-build:
    runs-on: ubuntu-latest
    needs: validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        working-directory: docs/
        
    - name: Build Jekyll site
      run: |
        cd docs
        bundle exec jekyll build --safe
        
    - name: Upload site artifacts
      uses: actions/upload-artifact@v3
      with:
        name: jekyll-site
        path: docs/_site/
        retention-days: 7
